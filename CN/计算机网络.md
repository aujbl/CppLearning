# 第一章 概论

1. 构成

    1. 节点：主机及其运行的应用程序、路由器、交换机

    2. 边：通信链路（接入网链路、主干链路）

    3. 协议：控制发送、接收消息

2. 网络结构

    1. 网络边缘：主机、应用程序

        1. 端系统（主机）

        2. 客户/服务器模式

        3. 对等peer-peer模式

    2. 网络核心：互连的路由器、网络的网络

        1. 电路交换：端到端的资源分配、网络资源被分成片（统计多路复用（FDM、TDM））

        2. 分组交换：以分组为单位，存储-转发方式；资源共享，按需使用

        3. 关键功能：路由、转发（数据报网络（类似问路）、虚电路网络（带标签，保持路径））

    3. 接入网、物理媒体：有线或无线通信链路

        1. 住宅接入（modem）网络、企业接入网络、无线接入网络

        2. 物理媒体：同轴电缆、光纤、无线链路（地面微波、LAN、wide-aera、卫星）

3. 分组延时、丢失和吞吐量

    1. 分组延时：节点处理延时、排队延时、传输延时、传播延时

        1. 传输时延：发送整个分组所需时间，与分组长度和链路传输速率相关

        2. 传播时延：发送一个比特所需时间，与链路长度有关

    2. 分组丢失：队列缓冲区容量有限，队列满时分组丢失、丢失的分组可能由上一节点或源端重传，也可能不重传

    3. 瞬间吞吐量/平均吞吐量

4. 协议层次及服务模型

    1. 服务和服务访问点(SAP)

    2. 服务类型：面向连接和无连接

    3. 服务和协议：本层协议靠下层提供的服务来实现，本层实体通过协议为上层提供服务

    4. 数据单元

5. Internet协议栈

    1. 应用层：FTP/SMTP/HTTP/DNS...（报文message）

    2. 传输层：TCP/UDP（报文段segment）

    3. 网络层：IP/路由协议（分组packet/datagram）

    4. 链路层：PPP/802.11/Ethernet（帧frame）

    5. 物理层：传输bit（位bit） 

# 第二章 应用层

1. 体系结构

    1. 客户-服务器（C/S）模式

    2. 对等模式（P2P：peer To Peer）

    3. 混合体

2. 分布式进程通信

    1. 对进程进行编址：IP + Port

    2. TCP Socket：一个整数本地标示，代表一个四元组（源IP/源端口/目标IP/目标端口）

    3. UDP Socket：本地IP + 本地Port，发送报文时要指定对方的IP和UDP Port

3. Web Http

    1. URL格式：协议名 + 用户名：口令 + 主机名 + 路径名 + 端口

    2. HTTP概况

        1. 使用TCP，默认端口80

        2. HTTP是无状态的，服务器不维护关于客户的信息

        3. 非持久HTTP/持久HTTP

            1. HTTP1.0使用非持久连接，HTTP1.1默认使用持久连接

            2. 持久HTTP（非流水式：一次只有一个请求，前一个响应后发出新请求 / 流水式：同时请求）

        4. HTTP请求报文

            1. 请求行（GET / POST / HEAD） + PUT/DELETE(HTTP1.1)

            2. + 首部行（Host / User-agent / Connection / Accept-language）

            3. + 实体部分

        5. HTTP响应报文

            1. 状态行（协议版本、状态码、相应状态信息）

                1. 状态码：200(OK) / 301(Moved Permanently) / 400(Bad Request) / 404(Not Foune) / 505(HTTP Version Not Supported)

            2. 首部行

            3. 数据

        6. 使用Cookies维护用户-服务器状态

        7. Web缓存：不访问原始服务器，满足客户的请求

        8. 条件GET方法：如果缓存器中的对象是最新的（请求时 + 最后修改时间），则不发送对象

4. FTP：文件传输协议

    1. 控制连接：带外传送

    2. 使用TCP传输协议

    3. 服务器维护用户状态信息

5. Email

    1. SMTP(push)

        1. 3个阶段：握手、传输报文、关闭

        2. 持久连接

        3. 报文格式：首部行(To: / From: / Subject:) + 主体（ASCII字符）

        4. MIME：多媒体邮件拓展

    2. POP3（邮局访问协议）(pull)

        1. 用户确认阶段

        2. 事务处理阶段

    3. IMAP

6. DNS

    1. 目的：实现主机名-IP地址的转换

    2. 主要思路：分层的、分布式的、运行在UDP的53号端口上、以应用层协议实现

    3. RR格式：Domain_name、TTL、Class、Value、Type

    4. 递归查询、迭代查询

    5. DNS协议：查询和相应报文的报文格式相同，通过标志位区分

7. P2P应用

    1. 问题：如何定位所需资源、如何处理peer的加入与离开

    2. 集中式目录：单点故障、性能瓶颈、侵犯版权

    3. 查询泛洪：Gnutella(ping-pong)

    4. KaZaA：组长跟踪所有组员，与其他组长联系；使用hash值查询

    5. BitTorrent
        
        1. tracker跟踪参与节点
        
        2. Torrent节点的组，之间交换文件块

        3. 稀缺优先、有限疏通

    6. DHT(Distributed Hash Table)结构化P2P

8. CDN(Content Distribution Networks)

    1. 多媒体流化服务(DASH: Dynamic Adaptive Streaming over HTTP)

9. TCP套接字编程

    1. 服务器：创建、捆绑、等待连接

    2. 客户端：创建（隐式捆绑）、连接

    3. 服务器接受连接 -> 建立TCP连接


10. UDP套接字编程

# 第三章 传输层

1. 网络层服务：主机之间的逻辑通信；传输层服务：进程之间的逻辑通信

2. 在发送方主机多路复用，在接收方主机多路解复用

3. 面向连接的多路复用可以解复用到不同线程

4. 无连接传输UDP

    1. “尽力而为”的服务，可能丢失和乱序

    2. 无连接：无握手，每个报文段独立处理

    3. 适用于流媒体、DNS、SNMP等（丢失不敏感，速率敏感）

    4. 用UDP校验和检测报文段的差错

5. 可靠数据传输（rdt）原理

    1. （rdt1.0）在可靠信道上进行可靠数据传输，使用有限状态机（FSM）描述发送方，接收方

    2. （rdt2.0）采用差错控制编码进行差错检测
    
        1. 确认(ACK)：接收方显式地告诉发送方已正确接收；否定确认(NAK)：接收方通知发送方发生差错

    3. （rdt2.1）使用序号解决ACK、NAK传输出错问题（停止等待协议）

    4. （rdt2.2）用先前正确接收的分组的ACk代替当前错误分组的NAK

    5. （rdt3.0）超时重传机制：解决分组丢失问题（分组丢失可能形成死锁）

    6. 流水线：允许发送方在未得到接收方确认的情况下一次发送多个分组（提高链路利用率）

        1. 需要增加序号的范围

        2. 在发送方、接收方需要缓冲区（发送：可能需要重传、接收：需要排序交付）

        3. 缓冲区大小 = 1：停止等待协议； > 1:流水线协议

    7. 流水线协议：回退N步(GBN)、选择重传(SR)

        1. 滑动窗口协议

            1. 发送窗口

                1. 相对移动：分组不动，可缓冲范围移动

                2. 发送分组时移动前沿，前沿移动不能超过发送缓冲区

                3. 接收到确认移动后沿，后沿不能超过前沿
        
            2. 接收窗口

                1. 尺寸 = 1（GBN：发送方窗口 > 1）：只能顺序接收，发送连续收到的最大的分组确认（累计确认）

                2. 尺寸 > 1（SR：发送方窗口 > 1）：可以乱序接收，发送收到分组的确认（独立确认）

                3. 乱序到来，缓冲但不交付、不滑动

        2. 总结

            1. GBN

                1. 发送端在流水线中最多有N个未确认分组

                2. 接收端累计确认，发现gap时，不确认新到来的分组

                3. 发送端只有一个最老的未确认分组的定时器，定时器到时重传所有未确认分组

            2. SR

                1. 发送端在流水线中最多有N个未确认分组

                2. 接收端单独确认

                3. 发送方为每个未确认分组保持一个定时器，超时只重传未确认分组

            3. 对比

                ||GBN|SR|
                |:-----:|:-----:|:-----:|
                |优点|简单，所需资源少|出错重传代价小|
                |缺点|回退N代价大|接收方所需资源多|
                |适用范围|出错率低|链路容量大|

6. 面向连接的传输：TCP

    1. 概述

        1. 点对点

        2. 全双工

        3. 可靠的、按顺序的字节流

        4. 管道化（流水线）

        5. 面向连接

        6. 发送和接收缓存

        7. 有流量控制

    2. TCP报文段

        1. 序号：报文段首字节在字节流中的编号
        
        2. 确认号：期望收到的下一字节的序号

        3. 往返延时RTT和超时

            1. 太早超时会引起不必要的重传

            2. 超时时间太长时对报文段丢失反应慢
        
    3. 快速重传：在定时器到时前重传

        1. 超时周期太长

        2. 通过重复的ACK来检测报文段的丢失

        3. 收到三个冗余的ACK，重传最小序号的段

    4. TCP流量控制

        1. 接收方控制发送方，减缓发送速度，以免接收方缓冲区溢出

        2. 接收方在rwnd字段告知空闲buffer大小

    5. TCP连接管理

        1. 同意建立连接、同意连接参数

        2. 2次握手的失败场景

            1. 半连接：只在服务器维护了连接

            2. 老的数据被当成新的数据接受了

        3. 3次握手解决半连接和接收老数据的问题

        4. 变化的初始序号解决网络滞留引起的问题

        5. 关闭连接：对称释放

7. 拥塞控制原理

    1. 表现：分组丢失、分组经历延时长

    2. 原因：带宽限制、有限的缓冲等；拥塞时超时重传可能导致网络急速瘫痪

    3. 理想化：掌握丢失信息

    4. 拥塞控制方法

        1. 端到端的拥塞控制：端系统根据延迟和丢失事件推断是否拥塞

        2. 网络辅助的拥塞控制：路由器提供反馈信息

    5. ATM ABR(available bit rate)拥塞控制（网络辅助）

        1. “弹性服务”

        2. RM(资源管理)单元：NI轻微拥塞、CI拥塞指示

8. TCP拥塞控制

    1. 端到端的拥塞控制机制：路由器不提供有关拥塞的反馈信息；端系统根据自身信息判断

    2. 主要问题：如何检测拥塞、控制策略

        1. 检测拥塞：某个段超时 -> 拥塞；3次重复ACK -> 轻微拥塞

        2. 控制速率：维持一个拥塞窗口值CongWin，限制已发送但未确认的数据量，控制注入速率

    3. 策略概述
    
        1. 慢启动阶段（SS）：连接开始时，指数性增加发送速率，直到发生丢失事件（初始慢、加速快）
        
        2. AIMD（乘性减、线性增）拥塞避免阶段（CA）
        
            1. （拥塞）发生丢失事件后，CongWin降为1，CongWin / 2作为阈值，下次只倍增到CongWin / 2，然后线性增（每次 + 1）
            
            2. （轻微拥塞：3次ACk）Threshold = CongWin / 2，CongWin = Threshold + 3，直接开始线性增，跳过慢启动
        
        3. 超时事件后的保守策略











